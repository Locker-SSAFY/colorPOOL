# 동적 이미지에 대한 export와 PDF

## html2canvas

> Javascript에서 지원하는 브라우저 화면 캡처 라이브러리

html 화면을 보고 있자면 가끔씩 '아 이대로 캡처해서 readme에 붙이고 싶다' 또는 '너무 이뻐서 이 페이지 간직하고 싶어!!!' 라는 생각이 들지도 모른다. 그럴 때를 위해 JavaScript에서는 **html2canvas**라는 라이브러리를 제공하고 있다.

취업을 준비하는 입장에서 천천히 **STAR 항목**을 이용해 우리의 이슈를 풀어나가 보겠다.

------

## Situation

우리는 색상에 대한 잡지를 만들고 있기 때문에 단순히 **잡지를 온라인 상에 저장해놓고 보는 것에 그치면 일회성 경험에 지나지 않는다**는 생각을 가지게 되었다. 그래서 잡지를 만든 이후 결과 페이지에서 잡지를 직접 PDF로 추출해 볼 수 있도록 하는 기능을 만들려고 했다. **잡지를 PDF화** 하기 위해서는 총 **3단계**가 필요했다.

> 잡지를 보는 뷰어 제작 → 잡지 페이지들 모두 스캔 → 잡지를 PDF로 저장

아 딱봐도 쉬워보인다. 그럼 하나씩 살펴보겠다.

- **잡지를 보는 뷰어 제작**

잡지를 보는 뷰어는 만들기 쉬웠다. 뷰어 제작에도 세부 단계가 있는데

첫번째로 데이터 바인딩이다.

발간한 잡지의 데이터를 바인딩해서 뷰어를 통해 간단하게 볼 수 있게 했다. **백엔드에서 불러온 잡지의 형식**과 **발간한 잡지의 데이터 양식이 맞지 않아** 우리 프로젝트에는 사실 **뷰어가 두 개**다.

두번째로 헤더를 없앴다.

헤더를 없앤 이유는 두 가지다. 첫번째로 우리 프로젝트에서 **헤더는 라우팅을 주 목적으로 한다**는 점이다. 만약 뷰어에서 라우팅을 통해 메인화면으로 간다면 사용자 입장에서는 새로운 ColorPOOL이 단순히 라우팅만 되서 나온 것이나 다름 없기 때문이다. 두 번째는 잡지 스캔과 관련이 되어 있는데, **헤더가 나와 있는 잡지 스캔은 솔직히 멋없**잖아? 프론트니까 UI/UX 중시하자, 항상!

마지막으로 주소표시줄을 없앴다.

위에서 열심히 헤더를 없애놓고 주소표시줄이 남아있다면? 사용자는 언제든지 내 뷰어에서 다른 곳으로 도망칠 수 있다. **주소표시줄을 없애서 오롯이 잡지 발간에만 집중하도록** 했다.

- **잡지 페이지들 모두 스캔**

이슈에 해당되는 내용은 '잡지 페이지들 모두 스캔'과 '잡지를 PDF로 저장'이다. 우리는 기본적으로 **이미지를 동적**으로 가져온다. 이 뜻은 서버에 이미지를 저장하거나 프론트에서 이미지를 가지고 있는 것이 아니라 단순히 URL만 가지고 와서 **페이지에서 렌더링 작업**을 한다는 뜻이다. 잡지인 만큼 이미지는 중요하기 때문에 버릴 수 없는 요소였고 잡지 페이지를 모두 스캔하기 위해 html2canvas라는 라이브러리를 사용하게 됐다.

- **잡지를 PDF로 저장**

잡지를 PDF로 저장하는 것 역시 어려운 것은 아닌 듯 했다. jspdf라는 라이브러리를 사용하면 위 단계에서 변환된 **canvas객체를 png이미지로 변환해 pdf로 생성하고 로컬에 저장**할 수 있다고 생각했기 때문이다.

> 아.. 지금까지 이상적인 PDF 만들기를 알아보았다. 그럼 지금부터 최종마감 하루전의 Socks 팀의 상황으로 들어가보겠다.

------

## Task

위에서 언급했듯이 우리 팀은 html2canvas와 jspdf라이브러리를 사용했다. 이 두가지 라이브러리를 사용해서 캐러셀에 담겨있는 **잡지 페이지를 모두 canvas에** 찍고, **jspdf 라이브러리를 사용하여 pdf로 변환**하는 과정이 필요했다.

html2canvas부터 얘기해보자면 나름 역사가 깊은 라이브러리다. 깃헙에 star는 무려 21769개를 자랑하고 1438명의 트위터 팔로워가 있으며 공식문서가 사이트로 따로 존재하는 라이브러리다. 

> 잦고 주기가 빠른 업데이트의 장점과 단점

html2canvas는 버전 업그레이드가 잦고 주기가 짧다고 한다. 이렇게 버전 업그레이드가 잦으면 좋은 점은 라이브러리의 사용성이 높고 인기가 많다는 것을 알 수 있고, 나쁜 점은 **버그가 많고 예제 코드가 안 먹히는 경우**도 종종 있다는 것이다. 예제 코드를 그대로 적용해도 안된다고 하는 경우를 자주 만날 수 있었다.

```jsx
window.html2canvas = html2canvas;
window.html2canvas(vc.showCaptureRef(),  { letterRendering: 1, allowTaint : true}).then(canvas => {
  console.log(canvas);
  this.saveAs(canvas.toDataURL(), "capture.png");
}).catch((error) => {
  console.log("Erorr descargando reporte visual", error)
});
```

이 html2canvas 방식은 결국 성공해서 print 쪽에 적용할 수 있었지만, 문제가 발생한 곳은 바로...

```jsx
this.saveAs(canvas.toDataURL(), "capture.png");
```

이 코드였다. **toDataURL이 필요한 이유**는 캔버스에 html을 다 append해서 붙여놨다고 하더라도 **캔버스 그 자체는 가상이기 때문에 PDF화 할 수 없어서**이다. 그래서 png형식으로 바꿔서 PDF로 저장을 하려고 했던 것이다.

------

## Action

png형식으로 바꿔주면서 문제가 발생했는데 어떤 문제였나면 위쪽 코드의 **AllowTaint로 인한 동적 이미지 문제**였다. html2canvas를 처음 시도했을 때는 allowTaint라는 옵션을 몰랐기 때문에 단순히 'canvas에 찍으면 나오겠다'해서 잡지 페이지들을 찍어 보았고, 잡지 페이지들의 이미지는 나오지 않았다.

> 동적 이미지와 export

AllowTaint 옵션을 이용하면서 곧바로 이미지들이 canvas에 찍히게 할 수 있었고, canvas를 이미지화하려는데 export 할 수 없다는 문구가 나왔다. 찾아보니 **html에서 렌더링된 이미지**를 allowTaint로 가져왔을 경우, **어떤 형태로든 export 할 수 없도록 막아 놓은 것**이었다.

> 프론트엔드에서의 PDF 실패

당연히 png로 변환할 수 없는 상태에서 pdf 변환은 무의미했지만 나름의 시도를 조금 해보았는데 이게 예상외로 쉽지 않았다. html2canvas와 마찬가지로 훌륭한 라이브러리였지만 촉박한 시간 때문인지, 방법이 틀렸던 건지 **뷰어의 canvas에서 pdf로 변환할 수 없었다**...

------

## Result

PDF 만드는데 실패했으니 버렸나? 우리 팀의 만능 풀스택 윤선생이 해결책을 제시했다.

> 윤선생의 아이디어 - **인쇄**

**"우리가 만드는 잡지는 온라인이지만 인쇄해서 받아 볼 수 있는 건 오프라인도 되는 거지"** 라는 윤선생의 말씀에 모든 팀원들께서 동의해주셨다. Print는 의외로 간단하다.

```jsx
window.print();
```

짧고 간결하다.

물론 A4용지 인쇄를 기준으로 했을 때 발생하는 **페이지간 거리를 계산해서 보이지 않는 div를 사이사이에 넣는 과정**이 필요하지만, PDF 추출 대신이기 때문에 그나마 높은 퀄리티를 유지하도록 노력했다.

물론 사용자가 '인쇄하기' 버튼을 클릭했을 때, 사용자가 손도 안 대도 인쇄창이 뜰 수 있게 하는 것에는 시간이 좀 걸렸다. 캐러셀을 자동으로 한 장씩 넘기면서 appendChild를 하고 마지막에는 캐러셀이 멈춰야 했기 때문이다.

------

## 결과

> 영상을 만들면서도 해결책을 제시해 준 윤선생... 고마워

사실 PDF는 팀이 우선적으로 생각했던 메인 기능 중 하나이다. 어떻게 보면 PDF로 만들어 나중에 공유까지 가능해진다면 훨씬 나은 기능이었을 수 있다. 질질 끌다가 결국 마지막 날에 와서야 PDF로 만드는 기능을 늦게 시도하고 불가능이라는 벽에 닿았을 때 윤선생이 구원의 밧줄을 내려주었다. PDF를 완벽하게 대체하지는 못했지만 뮹 팀원이 거금을 들여 오프라인으로 뽑아온 잡지를 보았을 때는 색 선택, 배색 선택, 이미지 선택, 잡지 편집, 잡지 발간까지 일련의 과정을 마쳤다는 것에 감격스러웠다. html2canvas, jspdf는 문서화가 잘 되어 있는 라이브러리고 PDF 만들기는 실제로 컨설턴트님도 쉽다고 언급할 수준의 기능이다. 미리미리 준비하고 고민하는 습관을 가지고, 프로젝트에 바로 적용은 아니더라도 조금씩이라도 기능을 선제작 후적용하는 모습을 보이자.